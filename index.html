<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>澳門消費券管家</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Header styles */
        .header-container {
            position: relative;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-title {
            margin: 0;
            font-size: 1.5rem;
        }
        .lang-switch {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            white-space: nowrap;
        }
        .summary-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        .summary-label {
            font-weight: bold;
        }
        .summary-value {
            color: #2196F3;
            font-weight: bold;
        }
        /* Table styles */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .header-title {
                font-size: 1.2rem;
            }
            .summary-container {
                padding: 10px;
            }
            th, td {
                padding: 8px;
                font-size: 0.9rem;
            }
            .main-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            .channel-btn {
                padding: 8px;
                font-size: 0.9rem;
            }
        }
        .main-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
        }
        .channel-menu {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .channel-btn {
            background: #2196F3;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .edit-btn {
            color: #2196F3;
            cursor: pointer;
            margin: 0 5px;
        }
        .expired {
            color: #e74c3c;
            font-weight: bold;
        }
        .edit-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        /* Footer styles */
        .footer {
            margin-top: auto; /* Push footer to the bottom */
            text-align: center; /* Center the text */
            padding: 30px 0; /* Add some padding */
            background: #f5f5f5; /* Match background color */
        }
        .footer a {
            margin: 0 10px;
            color: #2196F3; /* Link color */
            text-decoration: none; /* Remove underline */
        }
        .footer a:hover {
            text-decoration: underline; /* Underline on hover */
        }
        /* New styles for selected buttons */
        .selected-btn {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
        }
        /* Filter button styles */
        .filter-container {
            display: flex;
            justify-content: flex-end;
            margin: 10px 0;
            gap: 10px;
        }
        .filter-btn {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-btn.active {
            background: #1976D2;
        }
        .filter-btn i {
            font-size: 14px;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .filter-container {
                justify-content: center;
            }
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }
            .lang-switch {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="header-top">
            <h1 class="header-title" id="appTitle">消費券記錄App</h1>
            <button class="lang-switch" onclick="toggleLanguage()">English</button>
        </div>
        <div class="summary-container">
            <div class="summary-item">
                <span class="summary-label" id="totalConsumptionLabel">總消費額</span>
                <span id="totalConsumption" class="summary-value">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label" id="remainingCouponsLabel">剩餘消費券金額</span>
                <span id="remainingCoupons" class="summary-value">$0</span>
            </div>
        </div>
    </div>

    <div class="filter-container">
        <button class="filter-btn" onclick="toggleFilter()" id="filterBtn">
            <i class="fas fa-filter"></i>
            <span id="filterText">顯示未到期</span>
        </button>
    </div>

    <button class="main-btn" onclick="toggleChannels()" id="quickAddBtn">＋ 快速新增</button>
    <div class="channel-menu" id="channelMenu">
        <!-- 澳門八大支付渠道 -->
        <button class="channel-btn" data-channel="中銀手機銀行" data-channel-en="BOC Mobile Banking">中銀 BOC</button>
        <button class="channel-btn" data-channel="工銀e支付" data-channel-en="ICBC e-Payment">工銀 ICBC</button>
        <button class="channel-btn" data-channel="支付寶（澳門）Alipay" data-channel-en="Alipay (Macau)">支付寶（澳門）Alipay</button>
        <button class="channel-btn" data-channel="澳門通MPay" data-channel-en="Macau Pass MPay">澳門通 MPay</button>
        <button class="channel-btn" data-channel="廣發錢包" data-channel-en="CGB Wallet">廣發錢包</button>
        <button class="channel-btn" data-channel="LusoPay" data-channel-en="LusoPay">國際銀行 LusoPay</button>
        <button class="channel-btn" data-channel="大豐豐付寶" data-channel-en="Tai Fung Pay">大豐 豐付寶</button>
        <button class="channel-btn" data-channel="UePay" data-channel-en="UePay">南粵 UePay</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th id="dateHeader">輸入日期</th>
                    <th id="channelHeader">支付渠道</th>
                    <th id="coupon1Header">券1</th>
                    <th id="coupon2Header">券2</th>
                    <th id="coupon3Header">券3</th>
                    <th id="totalHeader">總消費額</th>
                    <th id="expiryHeader">過期日</th>
                    <th id="statusHeader">狀態</th>
                    <th id="actionHeader">操作</th>
                </tr>
            </thead>
            <tbody id="recordsBody"></tbody>
        </table>
    </div>

    <div class="footer">
        <span>© 2025 Eyesquare Ltd. X Nardo Lao</span>

            <a href="https://www.instagram.com/eyesquareai/" target="_blank">
                <i class="fab fa-instagram fa-lg"></i>
            </a>
            <a href="https://eyesquare.my.canva.site/home" target="_blank">Eyesquare</a>

    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('coupons')) || [];
        let currentLanguage = 'zh'; // Default language
        let showOnlyValid = false; // Track filter state

        // Add channel mapping for backward compatibility
        const channelMapping = {
            '中銀手機銀行': 'BOC Mobile Banking',
            '工銀e支付': 'ICBC e-Payment',
            '支付寶（澳門）Alipay': 'Alipay (Macau)',
            '澳門通MPay': 'Macau Pass MPay',
            '廣發錢包': 'CGB Wallet',
            'LusoPay': 'LusoPay',
            '大豐豐付寶': 'Tai Fung Pay',
            'UePay': 'UePay'
        };

        // Process existing records to add channelEn if missing
        records = records.map(record => {
            if (!record.channelEn && record.channel) {
                record.channelEn = channelMapping[record.channel] || record.channel;
            }
            return record;
        });
        saveData(); // Save the updated records

        // Language translations
        const translations = {
            zh: {
                appTitle: '消費券記錄App',
                totalConsumption: '總消費額',
                remainingCoupons: '剩餘消費券金額',
                quickAdd: '＋ 快速新增',
                date: '輸入日期',
                channel: '支付渠道',
                coupon1: '券1',
                coupon2: '券2',
                coupon3: '券3',
                total: '總消費額',
                expiry: '過期日',
                status: '狀態',
                action: '操作',
                delete: '刪除',
                edit: '✎',
                none: '無',
                unused: '未使用',
                used: '已使用',
                expired: '已過期',
                daysLeft: '剩',
                days: '天',
                valid: '有效',
                confirmDelete: '確定刪除此記錄？',
                close: '關閉',
                setCoupons: '設定優惠券',
                done: '完成',
                showAll: '顯示全部',
                showValidOnly: '顯示未到期'
            },
            en: {
                appTitle: 'Macau Coupon Manager',
                totalConsumption: 'Total Consumption',
                remainingCoupons: 'Remaining Coupons',
                quickAdd: '＋ Quick Add',
                date: 'Date',
                channel: 'Payment Channel',
                coupon1: 'Coupon 1',
                coupon2: 'Coupon 2',
                coupon3: 'Coupon 3',
                total: 'Total',
                expiry: 'Expiry Date',
                status: 'Status',
                action: 'Action',
                delete: 'Delete',
                edit: '✎',
                none: 'None',
                unused: 'Unused',
                used: 'Used',
                expired: 'Expired',
                daysLeft: 'Left',
                days: 'days',
                valid: 'Valid',
                confirmDelete: 'Are you sure you want to delete this record?',
                close: 'Close',
                setCoupons: 'Set Coupons',
                done: 'Done',
                showAll: 'Show All',
                showValidOnly: 'Show Valid Only'
            }
        };

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            document.querySelector('.lang-switch').textContent = currentLanguage === 'zh' ? 'English' : '中文';
            updateLanguage();
        }

        function updateLanguage() {
            const lang = translations[currentLanguage];
            
            // Update all text elements
            document.getElementById('appTitle').textContent = lang.appTitle;
            document.getElementById('totalConsumptionLabel').textContent = lang.totalConsumption;
            document.getElementById('remainingCouponsLabel').textContent = lang.remainingCoupons;
            document.getElementById('quickAddBtn').textContent = lang.quickAdd;
            document.getElementById('dateHeader').textContent = lang.date;
            document.getElementById('channelHeader').textContent = lang.channel;
            document.getElementById('coupon1Header').textContent = lang.coupon1;
            document.getElementById('coupon2Header').textContent = lang.coupon2;
            document.getElementById('coupon3Header').textContent = lang.coupon3;
            document.getElementById('totalHeader').textContent = lang.total;
            document.getElementById('expiryHeader').textContent = lang.expiry;
            document.getElementById('statusHeader').textContent = lang.status;
            document.getElementById('actionHeader').textContent = lang.action;
            
            // Update filter button text
            const filterText = document.getElementById('filterText');
            filterText.textContent = showOnlyValid 
                ? (currentLanguage === 'zh' ? '顯示全部' : 'Show All')
                : (currentLanguage === 'zh' ? '顯示未到期' : 'Show Valid Only');

            // Re-render table to update status texts
            renderTable();
        }

        // 初始化渠道按鈕
        document.querySelectorAll('.channel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                createRecord(btn.dataset.channel);
                toggleChannels();
            });
        });

        function toggleChannels() {
            document.getElementById('channelMenu').style.display = 
                document.getElementById('channelMenu').style.display === 'grid' ? 'none' : 'grid';
        }

        function createRecord(channel) {
            const today = new Date()
            today.setUTCDate(today.getUTCDate());
            const newRecord = {
                id: Date.now(),
                channel,
                channelEn: channelMapping[channel] || channel,
                dateAdded: today.toISOString().split('T')[0],
                coupons: [{ value: null, status: '未使用' }, { value: null, status: '未使用' }, { value: null, status: '未使用' }],
                expiry: getNextSunday(),
                total: 0
            };
            records.push(newRecord);
            saveData();
            renderTable();
            showCouponEditor(newRecord.id);
        }

        function updateButtonHighlighting(recordId, index, value) {
            const editorPanel = document.querySelector('.edit-panel');
            if (editorPanel) {
                const couponSection = editorPanel.querySelector(`.coupon-section[data-coupon-index="${index}"]`);
                if (couponSection) {
                    const buttons = couponSection.querySelectorAll('button');
                    buttons.forEach(btn => {
                        const btnValue = parseInt(btn.textContent) || 0;
                        if (btnValue === value) {
                            btn.classList.add('selected-btn');
                        } else {
                            btn.classList.remove('selected-btn');
                        }
                    });
                }
            }
        }

        function showCouponEditor(recordId) {
            const record = records.find(r => r.id === recordId);
            const lang = translations[currentLanguage];
            const channelDisplay = currentLanguage === 'zh' ? record.channel : record.channelEn;
            const editor = document.createElement('div');
            editor.className = 'edit-panel';
            editor.innerHTML = `
                <h3>${channelDisplay} - ${lang.setCoupons}</h3>
                <div style="display: grid; gap: 10px;">
                    ${record.coupons.map((coupon, index) => `
                        <div class="coupon-section" data-coupon-index="${index}">
                            <label>${lang.coupon1.replace('1', index+1)}：</label>
                            <div>
                                ${[lang.none, 10, 20, 50, 100, 200].map(v => {
                                    const value = v === lang.none ? 0 : v;
                                    const isSelected = coupon.value === value;
                                    return `
                                        <button onclick="updateCoupon(${recordId}, ${index}, ${value})" 
                                                class="${isSelected ? 'selected-btn' : ''}">
                                            ${v}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button style="margin-top:15px;" onclick="this.parentElement.remove()">${lang.done}</button>
            `;
            document.body.appendChild(editor);
        }

        function updateCoupon(recordId, index, value) {
            const record = records.find(r => r.id === recordId);
            const coupon = record.coupons[index];

            // Update coupon value and status
            if (coupon.status === '未使用') {
                coupon.value = value ? parseInt(value) : null;
                coupon.status = '未使用';
            } else {
                coupon.status = '未使用';
                coupon.value = null; // Reset value when toggled back to unused
            }

            // Recalculate total only for "未使用" coupons
            record.total = record.coupons.reduce((sum, c) => {
                return c.status === '未使用' ? sum + (c.value || 0) : sum;
            }, 0) * 3; // Multiply the sum by 3

            // Update button highlighting
            updateButtonHighlighting(recordId, index, value);

            saveData();
            renderTable();
            updateSummary();
        }

        function renderTable() {
            const tbody = document.getElementById('recordsBody');
            const lang = translations[currentLanguage];
            
            // Filter records if needed
            const filteredRecords = showOnlyValid 
                ? records.filter(record => {
                    const expiryDate = new Date(record.expiry);
                    const now = new Date();
                    now.setUTCDate(now.getUTCDate());
                    return expiryDate >= now;
                })
                : records;
            
            tbody.innerHTML = filteredRecords.map(record => {
                const expiryDate = new Date(record.expiry);
                const now = new Date();
                now.setUTCDate(now.getUTCDate());
                const diffTime = expiryDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 3600 * 24));

                let status = diffDays < 0 ? lang.expired : 
                            diffDays <= 7 ? `${lang.daysLeft}${diffDays}${lang.days}` : 
                            lang.valid;

                const dateAdded = record.dateAdded || "未記錄";
                const channelDisplay = currentLanguage === 'zh' ? record.channel : record.channelEn;

                return `
                    <tr>
                        <td>${dateAdded}</td>
                        <td>${channelDisplay}</td>
                        ${record.coupons.map((c, i) => `
                            <td ondblclick="toggleCouponStatus(${record.id}, ${i})" style="${c.status === lang.used ? 'text-decoration: line-through;' : ''}">
                                ${c.value !== null ? c.value : '-'}${c.status === lang.used ? ` (${c.status})` : ''}
                                <span class="edit-btn" onclick="editSingleCoupon(${record.id}, ${i})">${lang.edit}</span>
                            </td>
                        `).join('')}
                        <td>$${record.total}</td>
                        <td>${record.expiry.slice(0,10)}</td>
                        <td class="${status.includes(lang.expired) ? 'expired' : ''}">${status}</td>
                        <td>
                            <span class="edit-btn" onclick="deleteRecord(${record.id})">${lang.delete}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateSummary();
        }

        function editSingleCoupon(recordId, index) {
            const record = records.find(r => r.id === recordId);
            const lang = translations[currentLanguage];
            const channelDisplay = currentLanguage === 'zh' ? record.channel : record.channelEn;
            const editor = document.createElement('div');
            editor.className = 'edit-panel';
            editor.innerHTML = `
                <h3>${lang.setCoupons} ${index+1} for ${channelDisplay}</h3>
                <div class="coupon-section" data-coupon-index="${index}">
                    ${[lang.none, 10, 20, 50, 100, 200].map(v => {
                        const value = v === lang.none ? 0 : v;
                        const isSelected = record.coupons[index].value === value;
                        return `
                            <button onclick="updateCoupon(${recordId}, ${index}, ${value})" 
                                    class="${isSelected ? 'selected-btn' : ''}">
                                ${v}
                            </button>
                        `;
                    }).join('')}
                </div>
                <button style="margin-top:10px;" onclick="this.parentElement.remove()">${lang.close}</button>
            `;
            document.body.appendChild(editor);
        }

        function deleteRecord(id) {
            if(confirm(translations[currentLanguage].confirmDelete)) {
                records = records.filter(r => r.id !== id);
                saveData();
                renderTable();
            }
        }
        
        function getNextSunday() {
            const date = new Date();
            date.setUTCDate(date.getUTCDate() + ((7 - date.getUTCDay()) % 7 || 7));
            return date.toISOString().split('T')[0];
        }

        function saveData() {
            localStorage.setItem('coupons', JSON.stringify(records));
        }

        function toggleCouponStatus(recordId, index) {
            const record = records.find(r => r.id === recordId);
            const coupon = record.coupons[index];

            // Toggle the status of the coupon
            coupon.status = coupon.status === '未使用' ? '已使用' : '未使用';
            
            // Recalculate total - only counting "未使用" coupons
            record.total = record.coupons.reduce((sum, c) => {
                return c.status === '未使用' ? sum + (c.value || 0) : sum; // If '已使用', value is treated as 0
            }, 0) * 3; // Multiply the sum by 3
            
            saveData(); // Save to local storage
            renderTable();
        }
        
        // New function to update the summary section
        function updateSummary() {
            // Calculate total consumption (sum of all record totals)
            const totalConsumption = records.reduce((sum, record) => sum + record.total, 0);
            
            // Calculate remaining coupon amount (sum of all unused coupons)
            const remainingCoupons = records.reduce((sum, record) => {
                return sum + record.coupons.reduce((couponSum, coupon) => {
                    // Only count unused coupons and use their actual value
                    return coupon.status === '未使用' && coupon.value !== null ? couponSum + coupon.value : couponSum;
                }, 0);
            }, 0);
            
            // Update the summary display
            document.getElementById('totalConsumption').textContent = `$${totalConsumption}`;
            document.getElementById('remainingCoupons').textContent = `$${remainingCoupons}`;
        }

        function toggleFilter() {
            showOnlyValid = !showOnlyValid;
            const filterBtn = document.getElementById('filterBtn');
            const filterText = document.getElementById('filterText');
            
            if (showOnlyValid) {
                filterBtn.classList.add('active');
                filterText.textContent = currentLanguage === 'zh' ? '顯示全部' : 'Show All';
            } else {
                filterBtn.classList.remove('active');
                filterText.textContent = currentLanguage === 'zh' ? '顯示未到期' : 'Show Valid Only';
            }
            
            renderTable();
        }

        // 初始化
        renderTable();
    </script>
</body>
</html>