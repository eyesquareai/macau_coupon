<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>澳門消費券管家</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Header styles */
        .header-container {
            position: relative;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-title {
            margin: 0;
            font-size: 1.5rem;
        }
        .lang-switch {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            white-space: nowrap;
        }
        .summary-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        .summary-label {
            font-weight: bold;
        }
        .summary-value {
            color: #2196F3;
            font-weight: bold;
        }
        /* Table styles */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .header-title {
                font-size: 1.2rem;
            }
            .summary-container {
                padding: 10px;
            }
            th, td {
                padding: 8px;
                font-size: 0.9rem;
            }
            .main-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            .channel-btn {
                padding: 8px;
                font-size: 0.9rem;
            }
        }
        .main-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
        }
        .channel-menu {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .channel-btn {
            background: #2196F3;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .edit-btn {
            color: #2196F3;
            cursor: pointer;
            margin: 0 5px;
        }
        .expired {
            color: #e74c3c;
            font-weight: bold;
        }
        .edit-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        /* Footer styles */
        .footer {
            margin-top: auto; /* Push footer to the bottom */
            text-align: center; /* Center the text */
            padding: 30px 0; /* Add some padding */
            background: #f5f5f5; /* Match background color */
        }
        .footer a {
            margin: 0 10px;
            color: #2196F3; /* Link color */
            text-decoration: none; /* Remove underline */
        }
        .footer a:hover {
            text-decoration: underline; /* Underline on hover */
        }
        /* New styles for selected buttons */
        .selected-btn {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
        }
        /* Filter button styles */
        .filter-container {
            display: flex;
            justify-content: flex-end;
            margin: 10px 0;
            gap: 10px;
        }
        .filter-btn {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-btn.active {
            background: #1976D2;
        }
        .filter-btn i {
            font-size: 14px;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .filter-container {
                justify-content: center;
            }
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }
            .lang-switch {
                align-self: flex-end;
            }
        }
        /* Group styles */
        .group-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            border: 2px solid #fff;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }
        .group-color.selected {
            border: 2px solid #000;
        }
        .group-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        .group-picker.active {
            display: block;
        }
        .color-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .group-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .group-btn i {
            font-size: 14px;
        }
        .filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        .group-edit-btn {
            color: #2196F3;
            cursor: pointer;
            margin-left: 5px;
        }
        .group-filter-btn {
            background: #9C27B0;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        /* Coupon amount styles */
        .coupon-amount {
            font-size: 1.2em;
            font-weight: bold;
        }
        .coupon-amount.used {
            text-decoration: line-through;
            opacity: 0.7;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-buttons {
                width: 100%;
                justify-content: space-between;
            }
            .group-btn, .filter-btn {
                flex: 1;
                justify-content: center;
            }
        }
        /* 新增功能介紹彈窗樣式 */
        .help-btn {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .help-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .help-modal.active {
            display: block;
        }
        .help-section {
            margin-bottom: 15px;
        }
        .help-section h4 {
            margin-top: 10px;
            margin-bottom: 5px;
            color: #2196F3;
        }
        .delete-expired-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        /* 響應式調整 */
        @media (max-width: 600px) {
            .header-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                justify-content: flex-end;
            }
            .header-buttons button {
                font-size: 0.9rem;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="header-top">
            <h1 class="header-title" id="appTitle">消費券記錄App</h1>
            <div class="header-buttons">
                <button class="help-btn" onclick="toggleHelpModal()">
                    <i class="fas fa-question-circle"></i>
                    <span id="helpBtnText">功能介紹</span>
                </button>
                <button class="lang-switch" onclick="toggleLanguage()">English</button>
            </div>
        </div>
        <div class="summary-container">
            <div class="summary-item">
                <span class="summary-label" id="totalConsumptionLabel">總消費額</span>
                <span id="totalConsumption" class="summary-value">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label" id="remainingCouponsLabel">剩餘消費券金額</span>
                <span id="remainingCoupons" class="summary-value">$0</span>
            </div>
        </div>
    </div>

    <div class="filter-container">
        <div class="filter-buttons">
            <button class="group-btn" onclick="showGroupPicker()">
                <i class="fas fa-layer-group"></i>
                <span id="groupBtnText">選取分組</span>
            </button>
            <button class="group-filter-btn" onclick="toggleGroupFilter()" id="groupFilterBtn">
                <i class="fas fa-filter"></i>
                <span id="groupFilterText">顯示所有分組</span>
            </button>
            <button class="filter-btn" onclick="toggleFilter()" id="filterBtn">
                <i class="fas fa-filter"></i>
                <span id="filterText">顯示未到期</span>
            </button>
            <button class="delete-expired-btn" onclick="promptDeleteExpired()">
                <i class="fas fa-trash-alt"></i>
                <span id="deleteExpiredText">刪除過期</span>
            </button>
        </div>
    </div>

    <!-- 功能介紹模態框 -->
    <div class="help-modal" id="helpModal">
        <h3 id="helpModalTitle">功能介紹</h3>
        <div class="help-content">
            <div class="help-section">
                <h4 id="basicUsageTitle">基本使用</h4>
                <p id="basicUsageContent">點擊"快速新增"按鈕添加新的消費券記錄，選擇支付渠道後可設置不同面額的消費券。</p>
            </div>
            <div class="help-section">
                <h4 id="groupingTitle">分組功能</h4>
                <p id="groupingContent">點擊"選取分組"可為新紀錄分配顏色組。點擊記錄旁的編輯按鈕可更改現有記錄的分組。</p>
            </div>
            <div class="help-section">
                <h4 id="filteringTitle">篩選功能</h4>
                <p id="filteringContent">使用"顯示未到期"按鈕可以篩選出尚未過期的記錄。"顯示所有分組/顯示當前分組"可按分組查看記錄。</p>
            </div>
            <div class="help-section">
                <h4 id="deleteExpiredTitle">刪除過期</h4>
                <p id="deleteExpiredContent">點擊"刪除過期"按鈕可一次性刪除所有已過期的記錄。</p>
            </div>
            <div class="help-section">
                <h4 id="editingTitle">編輯功能</h4>
                <p id="editingContent">點擊記錄中的編輯按鈕可編輯消費券數值，雙擊可快速切換消費券的使用狀態。</p>
            </div>
        </div>
        <button onclick="toggleHelpModal()">關閉</button>
    </div>

    <div class="group-picker" id="groupPicker">
        <h3 id="groupPickerTitle">選擇分組顏色</h3>
        <div class="color-options">
            <div class="group-color" style="background-color: #FF5733;" onclick="selectGroupColor('#FF5733', event)"></div>
            <div class="group-color" style="background-color: #33FF57;" onclick="selectGroupColor('#33FF57', event)"></div>
            <div class="group-color" style="background-color: #3357FF;" onclick="selectGroupColor('#3357FF', event)"></div>
            <div class="group-color" style="background-color: #F033FF;" onclick="selectGroupColor('#F033FF', event)"></div>
            <div class="group-color" style="background-color: #FF8333;" onclick="selectGroupColor('#FF8333', event)"></div>
        </div>
        <button onclick="closeGroupPicker()">關閉</button>
    </div>

    <button class="main-btn" onclick="toggleChannels()" id="quickAddBtn">＋ 快速新增</button>
    <div class="channel-menu" id="channelMenu">
        <!-- 澳門八大支付渠道 -->
        <button class="channel-btn" data-channel="中銀手機銀行" data-channel-en="BOC Mobile Banking">中銀 BOC</button>
        <button class="channel-btn" data-channel="工銀e支付" data-channel-en="ICBC e-Payment">工銀 ICBC</button>
        <button class="channel-btn" data-channel="支付寶（澳門）Alipay" data-channel-en="Alipay (Macau)">支付寶（澳門）Alipay</button>
        <button class="channel-btn" data-channel="澳門通MPay" data-channel-en="Macau Pass MPay">澳門通 MPay</button>
        <button class="channel-btn" data-channel="廣發錢包" data-channel-en="CGB Wallet">廣發錢包</button>
        <button class="channel-btn" data-channel="LusoPay" data-channel-en="LusoPay">國際銀行 LusoPay</button>
        <button class="channel-btn" data-channel="大豐豐付寶" data-channel-en="Tai Fung Pay">大豐 豐付寶</button>
        <button class="channel-btn" data-channel="UePay" data-channel-en="UePay">南粵 UePay</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th id="groupHeader">分組</th>
                    <th id="dateHeader">輸入日期</th>
                    <th id="channelHeader">支付渠道</th>
                    <th id="coupon1Header">券1</th>
                    <th id="coupon2Header">券2</th>
                    <th id="coupon3Header">券3</th>
                    <th id="totalHeader">總消費額</th>
                    <th id="expiryHeader">過期日</th>
                    <th id="statusHeader">狀態</th>
                    <th id="actionHeader">操作</th>
                </tr>
            </thead>
            <tbody id="recordsBody"></tbody>
        </table>
    </div>

    <div class="footer">
        <span>© 2025 Eyesquare Ltd. X Nardo Lao</span>

            <a href="https://www.instagram.com/eyesquareai/" target="_blank">
                <i class="fab fa-instagram fa-lg"></i>
            </a>
            <a href="https://eyesquare.my.canva.site/home" target="_blank">Eyesquare</a>

    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('coupons')) || [];
        let currentLanguage = 'zh';
        let showOnlyValid = false;
        let selectedGroupColor = null;
        let showAllGroups = true;
        const DEFAULT_GROUP_COLOR = '#FF5733'; // Default color for existing records

        // Add channel mapping for backward compatibility
        const channelMapping = {
            '中銀手機銀行': 'BOC Mobile Banking',
            '工銀e支付': 'ICBC e-Payment',
            '支付寶（澳門）Alipay': 'Alipay (Macau)',
            '澳門通MPay': 'Macau Pass MPay',
            '廣發錢包': 'CGB Wallet',
            'LusoPay': 'LusoPay',
            '大豐豐付寶': 'Tai Fung Pay',
            'UePay': 'UePay'
        };

        // Process existing records to add channelEn if missing
        records = records.map(record => {
            if (!record.channelEn && record.channel) {
                record.channelEn = channelMapping[record.channel] || record.channel;
            }
            return record;
        });
        saveData(); // Save the updated records

        // Process existing records to add default group color if missing
        records = records.map(record => {
            if (!record.groupColor) {
                record.groupColor = DEFAULT_GROUP_COLOR;
            }
            return record;
        });
        saveData();

        // Language translations
        const translations = {
            zh: {
                appTitle: '消費券記錄App',
                totalConsumption: '總消費額',
                remainingCoupons: '剩餘消費券金額',
                quickAdd: '＋ 快速新增',
                date: '輸入日期',
                channel: '支付渠道',
                coupon1: '券1',
                coupon2: '券2',
                coupon3: '券3',
                total: '總消費額',
                expiry: '過期日',
                status: '狀態',
                action: '操作',
                delete: '刪除',
                edit: '✎',
                none: '無',
                unused: '未使用',
                used: '已使用',
                expired: '已過期',
                daysLeft: '剩',
                days: '天',
                valid: '有效',
                confirmDelete: '確定刪除此記錄？',
                close: '關閉',
                setCoupons: '設定優惠券',
                done: '完成',
                showAll: '顯示全部',
                showValidOnly: '顯示未到期',
                createGroup: '選取分組',
                selectGroupColor: '選擇分組顏色',
                group: '分組',
                showAllGroups: '顯示所有分組',
                showSelectedGroup: '顯示當前分組',
                editGroup: '編輯分組',
                helpButton: '功能介紹',
                deleteExpired: '刪除過期',
                confirmDeleteExpired: '確定要刪除所有已過期的記錄嗎？',
                helpModalTitle: '功能介紹',
                basicUsageTitle: '基本使用',
                basicUsageContent: '點擊"快速新增"按鈕添加新的消費券記錄，選擇支付渠道後可設置不同面額的消費券。',
                groupingTitle: '分組功能',
                groupingContent: '點擊"選取分組"可為新紀錄分配顏色組。點擊記錄旁的編輯按鈕可更改現有記錄的分組。',
                filteringTitle: '篩選功能',
                filteringContent: '使用"顯示未到期"按鈕可以篩選出尚未過期的記錄。"顯示所有分組/顯示當前分組"可按分組查看記錄。',
                deleteExpiredTitle: '刪除過期',
                deleteExpiredContent: '點擊"刪除過期"按鈕可一次性刪除所有已過期的記錄。',
                editingTitle: '編輯功能',
                editingContent: '點擊記錄中的編輯按鈕可編輯消費券數值，雙擊可快速切換消費券的使用狀態。'
            },
            en: {
                appTitle: 'Macau Coupon Manager',
                totalConsumption: 'Total Consumption',
                remainingCoupons: 'Remaining Coupons',
                quickAdd: '＋ Quick Add',
                date: 'Date',
                channel: 'Payment Channel',
                coupon1: 'Coupon 1',
                coupon2: 'Coupon 2',
                coupon3: 'Coupon 3',
                total: 'Total',
                expiry: 'Expiry Date',
                status: 'Status',
                action: 'Action',
                delete: 'Delete',
                edit: '✎',
                none: 'None',
                unused: 'Unused',
                used: 'Used',
                expired: 'Expired',
                daysLeft: 'Left',
                days: 'days',
                valid: 'Valid',
                confirmDelete: 'Are you sure you want to delete this record?',
                close: 'Close',
                setCoupons: 'Set Coupons',
                done: 'Done',
                showAll: 'Show All',
                showValidOnly: 'Show Valid Only',
                createGroup: 'Select Group',
                selectGroupColor: 'Select Group Color',
                group: 'Group',
                showAllGroups: 'Show All Groups',
                showSelectedGroup: 'Show Current Group',
                editGroup: 'Edit Group',
                helpButton: 'Help',
                deleteExpired: 'Delete Expired',
                confirmDeleteExpired: 'Are you sure you want to delete all expired records?',
                helpModalTitle: 'Features Guide',
                basicUsageTitle: 'Basic Usage',
                basicUsageContent: 'Click "Quick Add" button to add new coupon records. After selecting a payment channel, you can set different coupon denominations.',
                groupingTitle: 'Grouping',
                groupingContent: 'Click "Select Group" to assign a color group to new records. Click the edit button next to a record to change its group.',
                filteringTitle: 'Filtering',
                filteringContent: 'Use "Show Valid Only" to filter out non-expired records. "Show All Groups/Show Current Group" to view records by group.',
                deleteExpiredTitle: 'Delete Expired',
                deleteExpiredContent: 'Click "Delete Expired" button to remove all expired records at once.',
                editingTitle: 'Editing',
                editingContent: 'Click the edit button in a record to edit coupon values, double-click to quickly toggle coupon usage status.'
            }
        };

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            document.querySelector('.lang-switch').textContent = currentLanguage === 'zh' ? 'English' : '中文';
            updateLanguage();
        }

        function updateLanguage() {
            const lang = translations[currentLanguage];
            
            // Update all text elements
            document.getElementById('appTitle').textContent = lang.appTitle;
            document.getElementById('totalConsumptionLabel').textContent = lang.totalConsumption;
            document.getElementById('remainingCouponsLabel').textContent = lang.remainingCoupons;
            document.getElementById('quickAddBtn').textContent = lang.quickAdd;
            document.getElementById('dateHeader').textContent = lang.date;
            document.getElementById('channelHeader').textContent = lang.channel;
            document.getElementById('coupon1Header').textContent = lang.coupon1;
            document.getElementById('coupon2Header').textContent = lang.coupon2;
            document.getElementById('coupon3Header').textContent = lang.coupon3;
            document.getElementById('totalHeader').textContent = lang.total;
            document.getElementById('expiryHeader').textContent = lang.expiry;
            document.getElementById('statusHeader').textContent = lang.status;
            document.getElementById('actionHeader').textContent = lang.action;
            document.getElementById('groupHeader').textContent = lang.group;
            document.getElementById('groupBtnText').textContent = lang.createGroup;
            document.getElementById('groupPickerTitle').textContent = lang.selectGroupColor;
            document.getElementById('groupFilterText').textContent = 
                showAllGroups ? lang.showAllGroups : lang.showSelectedGroup;
            document.getElementById('helpBtnText').textContent = lang.helpButton;
            document.getElementById('deleteExpiredText').textContent = lang.deleteExpired;
            
            // 更新幫助模態框內容
            document.getElementById('helpModalTitle').textContent = lang.helpModalTitle;
            document.getElementById('basicUsageTitle').textContent = lang.basicUsageTitle;
            document.getElementById('basicUsageContent').textContent = lang.basicUsageContent;
            document.getElementById('groupingTitle').textContent = lang.groupingTitle;
            document.getElementById('groupingContent').textContent = lang.groupingContent;
            document.getElementById('filteringTitle').textContent = lang.filteringTitle;
            document.getElementById('filteringContent').textContent = lang.filteringContent;
            document.getElementById('deleteExpiredTitle').textContent = lang.deleteExpiredTitle;
            document.getElementById('deleteExpiredContent').textContent = lang.deleteExpiredContent;
            document.getElementById('editingTitle').textContent = lang.editingTitle;
            document.getElementById('editingContent').textContent = lang.editingContent;
            
            // Update filter button text
            const filterText = document.getElementById('filterText');
            filterText.textContent = showOnlyValid 
                ? (currentLanguage === 'zh' ? '顯示全部' : 'Show All')
                : (currentLanguage === 'zh' ? '顯示未到期' : 'Show Valid Only');

            renderTable();
        }

        // 初始化渠道按鈕
        document.querySelectorAll('.channel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                createRecord(btn.dataset.channel);
                toggleChannels();
            });
        });

        function toggleChannels() {
            document.getElementById('channelMenu').style.display = 
                document.getElementById('channelMenu').style.display === 'grid' ? 'none' : 'grid';
        }

        function createRecord(channel) {
            const today = new Date()
            today.setUTCDate(today.getUTCDate());
            const newRecord = {
                id: Date.now(),
                channel,
                channelEn: channelMapping[channel] || channel,
                dateAdded: today.toISOString().split('T')[0],
                coupons: [{ value: null, status: '未使用' }, { value: null, status: '未使用' }, { value: null, status: '未使用' }],
                expiry: getNextSunday(),
                total: 0,
                groupColor: selectedGroupColor
            };
            records.push(newRecord);
            saveData();
            renderTable();
            showCouponEditor(newRecord.id);
        }

        function updateButtonHighlighting(recordId, index, value) {
            const editorPanel = document.querySelector('.edit-panel');
            if (editorPanel) {
                const couponSection = editorPanel.querySelector(`.coupon-section[data-coupon-index="${index}"]`);
                if (couponSection) {
                    const buttons = couponSection.querySelectorAll('button');
                    buttons.forEach(btn => {
                        const btnValue = parseInt(btn.textContent) || 0;
                        if (btnValue === value) {
                            btn.classList.add('selected-btn');
                        } else {
                            btn.classList.remove('selected-btn');
                        }
                    });
                }
            }
        }

        function showCouponEditor(recordId) {
            const record = records.find(r => r.id === recordId);
            const lang = translations[currentLanguage];
            const channelDisplay = currentLanguage === 'zh' ? record.channel : record.channelEn;
            const editor = document.createElement('div');
            editor.className = 'edit-panel';
            editor.innerHTML = `
                <h3>${channelDisplay} - ${lang.setCoupons}</h3>
                <div style="display: grid; gap: 10px;">
                    ${record.coupons.map((coupon, index) => `
                        <div class="coupon-section" data-coupon-index="${index}">
                            <label>${lang.coupon1.replace('1', index+1)}：</label>
                            <div>
                                ${[lang.none, 10, 20, 50, 100, 200].map(v => {
                                    const value = v === lang.none ? 0 : v;
                                    const isSelected = coupon.value === value;
                                    return `
                                        <button onclick="updateCoupon(${recordId}, ${index}, ${value})" 
                                                class="${isSelected ? 'selected-btn' : ''}">
                                            ${v}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button style="margin-top:15px;" onclick="this.parentElement.remove()">${lang.done}</button>
            `;
            document.body.appendChild(editor);
        }

        function updateCoupon(recordId, index, value) {
            const record = records.find(r => r.id === recordId);
            const coupon = record.coupons[index];

            // Update coupon value and status
            if (coupon.status === '未使用') {
                coupon.value = value ? parseInt(value) : null;
                coupon.status = '未使用';
            } else {
                coupon.status = '未使用';
                coupon.value = null; // Reset value when toggled back to unused
            }

            // Recalculate total only for "未使用" coupons
            record.total = record.coupons.reduce((sum, c) => {
                return c.status === '未使用' ? sum + (c.value || 0) : sum;
            }, 0) * 3; // Multiply the sum by 3

            // Update button highlighting
            updateButtonHighlighting(recordId, index, value);

            saveData();
            renderTable();
            updateSummary();
        }

        function renderTable() {
            const tbody = document.getElementById('recordsBody');
            const lang = translations[currentLanguage];
            
            // Filter records based on validity and group color
            const filteredRecords = records.filter(record => {
                const isValid = !showOnlyValid || new Date(record.expiry) >= new Date();
                const isInGroup = showAllGroups || record.groupColor === selectedGroupColor;
                return isValid && isInGroup;
            });
            
            tbody.innerHTML = filteredRecords.map(record => {
                const expiryDate = new Date(record.expiry);
                const now = new Date();
                now.setUTCDate(now.getUTCDate());
                const diffTime = expiryDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 3600 * 24));

                let status = diffDays < 0 ? lang.expired : 
                            diffDays <= 7 ? `${lang.daysLeft}${diffDays}${lang.days}` : 
                            lang.valid;

                const dateAdded = record.dateAdded || "未記錄";
                const channelDisplay = currentLanguage === 'zh' ? record.channel : record.channelEn;

                return `
                    <tr>
                        <td>
                            <div class="group-color" style="background-color: ${record.groupColor};"></div>
                            <span class="group-edit-btn" onclick="editGroupColor(${record.id})">✎</span>
                        </td>
                        <td>${dateAdded}</td>
                        <td>${channelDisplay}</td>
                        ${record.coupons.map((c, i) => `
                            <td ondblclick="toggleCouponStatus(${record.id}, ${i})">
                                <span class="coupon-amount ${c.status === lang.used ? 'used' : ''}">
                                    ${c.value !== null ? c.value : '-'}
                                </span>
                                ${c.status === lang.used ? ` (${c.status})` : ''}
                                <span class="edit-btn" onclick="editSingleCoupon(${record.id}, ${i})">${lang.edit}</span>
                            </td>
                        `).join('')}
                        <td>$${record.total}</td>
                        <td>${record.expiry.slice(0,10)}</td>
                        <td class="${status.includes(lang.expired) ? 'expired' : ''}">${status}</td>
                        <td>
                            <span class="edit-btn" onclick="deleteRecord(${record.id})">${lang.delete}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateSummary();
        }

        function editSingleCoupon(recordId, index) {
            const record = records.find(r => r.id === recordId);
            const lang = translations[currentLanguage];
            const channelDisplay = currentLanguage === 'zh' ? record.channel : record.channelEn;
            const editor = document.createElement('div');
            editor.className = 'edit-panel';
            editor.innerHTML = `
                <h3>${lang.setCoupons} ${index+1} for ${channelDisplay}</h3>
                <div class="coupon-section" data-coupon-index="${index}">
                    ${[lang.none, 10, 20, 50, 100, 200].map(v => {
                        const value = v === lang.none ? 0 : v;
                        const isSelected = record.coupons[index].value === value;
                        return `
                            <button onclick="updateCoupon(${recordId}, ${index}, ${value})" 
                                    class="${isSelected ? 'selected-btn' : ''}">
                                ${v}
                            </button>
                        `;
                    }).join('')}
                </div>
                <button style="margin-top:10px;" onclick="this.parentElement.remove()">${lang.close}</button>
            `;
            document.body.appendChild(editor);
        }

        function deleteRecord(id) {
            if(confirm(translations[currentLanguage].confirmDelete)) {
                records = records.filter(r => r.id !== id);
                saveData();
                renderTable();
            }
        }
        
        function getNextSunday() {
            const date = new Date();
            date.setUTCDate(date.getUTCDate() + ((7 - date.getUTCDay()) % 7 || 7));
            return date.toISOString().split('T')[0];
        }

        function saveData() {
            localStorage.setItem('coupons', JSON.stringify(records));
        }

        function toggleCouponStatus(recordId, index) {
            const record = records.find(r => r.id === recordId);
            const coupon = record.coupons[index];

            // Toggle the status of the coupon
            coupon.status = coupon.status === '未使用' ? '已使用' : '未使用';
            
            // Recalculate total - only counting "未使用" coupons
            record.total = record.coupons.reduce((sum, c) => {
                return c.status === '未使用' ? sum + (c.value || 0) : sum; // If '已使用', value is treated as 0
            }, 0) * 3; // Multiply the sum by 3
            
            saveData(); // Save to local storage
            renderTable();
        }
        
        function updateSummary() {
            // Filter records based on group selection
            const filteredRecords = showAllGroups 
                ? records 
                : records.filter(record => record.groupColor === selectedGroupColor);

            // Calculate total consumption (sum of all record totals)
            const totalConsumption = filteredRecords.reduce((sum, record) => sum + record.total, 0);
            
            // Calculate remaining coupon amount (sum of all unused coupons)
            const remainingCoupons = filteredRecords.reduce((sum, record) => {
                return sum + record.coupons.reduce((couponSum, coupon) => {
                    // Only count unused coupons and use their actual value
                    return coupon.status === '未使用' && coupon.value !== null ? couponSum + coupon.value : couponSum;
                }, 0);
            }, 0);
            
            // Update the summary display
            document.getElementById('totalConsumption').textContent = `$${totalConsumption}`;
            document.getElementById('remainingCoupons').textContent = `$${remainingCoupons}`;
        }

        function toggleFilter() {
            showOnlyValid = !showOnlyValid;
            const filterBtn = document.getElementById('filterBtn');
            const filterText = document.getElementById('filterText');
            
            if (showOnlyValid) {
                filterBtn.classList.add('active');
                filterText.textContent = currentLanguage === 'zh' ? '顯示全部' : 'Show All';
            } else {
                filterBtn.classList.remove('active');
                filterText.textContent = currentLanguage === 'zh' ? '顯示未到期' : 'Show Valid Only';
            }
            
            renderTable();
        }

        function showGroupPicker() {
            document.getElementById('groupPicker').classList.add('active');
        }

        function closeGroupPicker() {
            document.getElementById('groupPicker').classList.remove('active');
        }

        function toggleGroupFilter() {
            showAllGroups = !showAllGroups;
            const groupFilterBtn = document.getElementById('groupFilterBtn');
            const groupFilterText = document.getElementById('groupFilterText');
            
            if (showAllGroups) {
                groupFilterBtn.classList.remove('active');
                groupFilterText.textContent = currentLanguage === 'zh' ? '顯示所有分組' : 'Show All Groups';
            } else {
                groupFilterBtn.classList.add('active');
                groupFilterText.textContent = currentLanguage === 'zh' ? '顯示當前分組' : 'Show Current Group';
            }
            
            renderTable();
            updateSummary(); // Update summary when group filter changes
        }

        function editGroupColor(recordId) {
            const record = records.find(r => r.id === recordId);
            if (record) {
                selectedGroupColor = record.groupColor;
                showGroupPicker();
                // Store the record ID to update after color selection
                document.getElementById('groupPicker').dataset.recordId = recordId;
                
                // Highlight the currently selected color
                document.querySelectorAll('.group-picker .group-color').forEach(el => {
                    el.classList.remove('selected');
                    if (el.style.backgroundColor === record.groupColor) {
                        el.classList.add('selected');
                    }
                });
            }
        }

        function selectGroupColor(color, event) {
            const recordId = document.getElementById('groupPicker').dataset.recordId;
            
            if (recordId) {
                // Convert recordId from string to number
                const recordIdNum = parseInt(recordId);
                // Update existing record's group color
                const record = records.find(r => r.id === recordIdNum);
                if (record) {
                    record.groupColor = color;
                    saveData();
                }
                document.getElementById('groupPicker').dataset.recordId = '';
            } else {
                // Set color for new records
                selectedGroupColor = color;
            }
            
            // Update UI to show selected color
            document.querySelectorAll('.group-color').forEach(el => {
                el.classList.remove('selected');
            });
            
            if (event && event.target) {
                event.target.classList.add('selected');
            }
            
            renderTable();
            updateSummary();
            closeGroupPicker();
        }

        // 功能介紹模態框切換
        function toggleHelpModal() {
            const helpModal = document.getElementById('helpModal');
            helpModal.classList.toggle('active');
        }

        // 刪除過期記錄
        function promptDeleteExpired() {
            const lang = translations[currentLanguage];
            if (confirm(lang.confirmDeleteExpired)) {
                deleteExpiredRecords();
            }
        }

        function deleteExpiredRecords() {
            const today = new Date();
            today.setUTCDate(today.getUTCDate());
            
            // 過濾出未過期的記錄
            const newRecords = records.filter(record => {
                const expiryDate = new Date(record.expiry);
                return expiryDate >= today;
            });
            
            // 如果有記錄被刪除，更新數據並重新渲染
            if (newRecords.length < records.length) {
                records = newRecords;
                saveData();
                renderTable();
            }
        }

        // Initialize
        renderTable();
    </script>
</body>
</html>