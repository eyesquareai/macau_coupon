<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>澳門消費券管家</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure the body takes full height */
        }
        .main-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
        }
        .channel-menu {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .channel-btn {
            background: #2196F3;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        .edit-btn {
            color: #2196F3;
            cursor: pointer;
            margin: 0 5px;
        }
        .expired {
            color: #e74c3c;
            font-weight: bold;
        }
        .edit-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        /* Footer styles */
        .footer {
            margin-top: auto; /* Push footer to the bottom */
            text-align: center; /* Center the text */
            padding: 30px 0; /* Add some padding */
            background: #f5f5f5; /* Match background color */
        }
        .footer a {
            margin: 0 10px;
            color: #2196F3; /* Link color */
            text-decoration: none; /* Remove underline */
        }
        .footer a:hover {
            text-decoration: underline; /* Underline on hover */
        }
    </style>
</head>
<body>
    <h1>消費券記錄App</h1>
    <button class="main-btn" onclick="toggleChannels()">＋ 快速新增</button>
    <div class="channel-menu" id="channelMenu">
        <!-- 澳門八大支付渠道 -->
        <button class="channel-btn" data-channel="中銀手機銀行">中銀 BOC</button>
        <button class="channel-btn" data-channel="工銀e支付">工銀 ICBC</button>
        <button class="channel-btn" data-channel="支付寶（澳門）Alipay">支付寶（澳門）Alipay</button>
        <button class="channel-btn" data-channel="澳門通MPay">澳門通 MPay</button>
        <button class="channel-btn" data-channel="廣發錢包">廣發錢包 </button>
        <button class="channel-btn" data-channel="LusoPay">國際銀行 LusoPay</button>
        <button class="channel-btn" data-channel="大豐豐付寶">大豐 豐付寶</button>
        <button class="channel-btn" data-channel="UePay">南粵 UePay</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>輸入日期</th>
                <th>支付渠道</th>
                <th>券1</th>
                <th>券2</th>
                <th>券3</th>
                <th>總消費額</th>
                <th>過期日</th>
                <th>狀態</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="recordsBody"></tbody>
    </table>

    <div class="footer">
        <span>© 2025 Eyesquare Ltd. X Nardo Lao</span>

            <a href="https://www.instagram.com/eyesquareai/" target="_blank">
                <i class="fab fa-instagram fa-lg"></i>
            </a>
            <a href="https://eyesquare.my.canva.site/home" target="_blank">Eyesquare</a>

    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('coupons')) || [];

        // 初始化渠道按鈕
        document.querySelectorAll('.channel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                createRecord(btn.dataset.channel);
                toggleChannels();
            });
        });

        function toggleChannels() {
            document.getElementById('channelMenu').style.display = 
                document.getElementById('channelMenu').style.display === 'grid' ? 'none' : 'grid';
        }

        function createRecord(channel) {
            const today = new Date()
            today.setUTCDate(today.getUTCDate());
            const newRecord = {
                id: Date.now(),
                channel,
                dateAdded: today.toISOString().split('T')[0], // Get today's date in YYYY-MM-DD format
                coupons: [{ value: null, status: '未使用' }, { value: null, status: '未使用' }, { value: null, status: '未使用' }],
                expiry: getNextSunday(),
                total: 0
            };
            records.push(newRecord);
            saveData();
            renderTable();
            showCouponEditor(newRecord.id);
        }

        function showCouponEditor(recordId) {
            const record = records.find(r => r.id === recordId);
            const editor = document.createElement('div');
            editor.className = 'edit-panel';
            editor.innerHTML = `
                <h3>${record.channel} - 設定優惠券</h3>
                <div style="display: grid; gap: 10px;">
                    ${record.coupons.map((_, index) => `
                        <div>
                            <label>券${index+1}：</label>
                            <div>
                                ${['無', 10, 20, 50, 100, 200].map(v => `
                                    <button onclick="updateCoupon(${recordId}, ${index}, ${v === '無' ? 0 : v})">
                                        ${v}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button style="margin-top:15px;" onclick="this.parentElement.remove()">完成</button>
            `;
            document.body.appendChild(editor);
        }

        function updateCoupon(recordId, index, value) {
            const record = records.find(r => r.id === recordId);
            const coupon = record.coupons[index];

            // Update coupon value and status
            if (coupon.status === '未使用') {
                coupon.value = value ? parseInt(value) : null;
                coupon.status = '未使用';
            } else {
                coupon.status = '未使用';
                coupon.value = null; // Reset value when toggled back to unused
            }

            // Recalculate total only for "未使用" coupons
            record.total = record.coupons.reduce((sum, c) => {
                return c.status === '未使用' ? sum + (c.value || 0) : sum;
            }, 0) * 3; // Multiply the sum by 3
            saveData();
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = records.map(record => {
                const expiryDate = new Date(record.expiry);
                const now = new Date();
                now.setUTCDate(now.getUTCDate());
                const diffTime = expiryDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 3600 * 24));

                let status = diffDays < 0 ? '已過期' : diffDays <= 7 ? `剩${diffDays}天` : '有效';

                // If the record doesn't have a dateAdded (for older records), use a placeholder
                const dateAdded = record.dateAdded || "未記錄";

                return `
                    <tr>
                        <td>${dateAdded}</td>
                        <td>${record.channel}</td>
                        ${record.coupons.map((c, i) => `
                            <td ondblclick="toggleCouponStatus(${record.id}, ${i})" style="${c.status === '已使用' ? 'text-decoration: line-through;' : ''}">
                                ${c.value !== null ? c.value : '-'}${c.status === '已使用' ? ` (${c.status})` : ''}
                                <span class="edit-btn" onclick="editSingleCoupon(${record.id}, ${i})">✎</span>
                            </td>
                        `).join('')}
                        <td>$${record.total}</td>
                        <td>${record.expiry.slice(0,10)}</td>
                        <td class="${status.includes('過期') ? 'expired' : ''}">${status}</td>
                        <td>
                            <span class="edit-btn" onclick="deleteRecord(${record.id})">刪除</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editSingleCoupon(recordId, index) {
            const record = records.find(r => r.id === recordId);
            const editor = document.createElement('div');
            editor.className = 'edit-panel';
            editor.innerHTML = `
                <h3>修改 ${record.channel} 的券${index+1}</h3>
                <div>
                    ${['無', 10, 20, 50, 100, 200].map(v => `
                        <button onclick="updateCoupon(${recordId}, ${index}, ${v === '無' ? 0 : v})" 
                                style="${record.coupons[index] === (v === '無' ? 0 : v) ? 'font-weight: bold;' : ''}">
                            ${v}
                        </button>
                    `).join('')}
                </div>
                <button style="margin-top:10px;" onclick="this.parentElement.remove()">關閉</button>
            `;
            document.body.appendChild(editor);
        }

        function deleteRecord(id) {
            if(confirm('確定刪除此記錄？')) {
                records = records.filter(r => r.id !== id);
                saveData();
                renderTable();
            }
        }
        
        function getNextSunday() {
            const date = new Date();
            date.setUTCDate(date.getUTCDate() + ((7 - date.getUTCDay()) % 7 || 7));
            return date.toISOString().split('T')[0];
        }

        function saveData() {
            localStorage.setItem('coupons', JSON.stringify(records));
        }

        function toggleCouponStatus(recordId, index) {
            const record = records.find(r => r.id === recordId);
            const coupon = record.coupons[index];

            // Toggle the status of the coupon
            coupon.status = coupon.status === '未使用' ? '已使用' : '未使用';
            
            // Recalculate total - only counting "未使用" coupons
            record.total = record.coupons.reduce((sum, c) => {
                return c.status === '未使用' ? sum + (c.value || 0) : sum; // If '已使用', value is treated as 0
            }, 0) * 3; // Multiply the sum by 3
            
            saveData(); // Save to local storage
            renderTable();
        }

        // 初始化
        renderTable();
    </script>
</body>
</html>
